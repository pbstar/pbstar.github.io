/*!
* p-camera-h5 v2.0.3
* Copyright 2024 Pbstar (https://github.com/pbstar)
* Licensed under MIT (https://github.com/pbstar/p-camera-h5/blob/main/LICENSE)
* 2025-08-30 20:23:47
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).pCameraH5=t()}(this,(function(){"use strict";const e=(...t)=>{const i={};function r(e){return null!==e&&"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)}return t.forEach((t=>{if(r(t))for(const a in t)if(t.hasOwnProperty(a)){const n=t[a],o=i[a];r(n)?(r(o)||(i[a]={}),i[a]=e(o,n)):Array.isArray(n)?i[a]=[...n]:i[a]=n}})),i},t=e=>{const t=document.getElementById("p-error");t.textContent=e,t.style.display="block",console.error(e)},i=async(e,i)=>{const r=e=>new Promise(((t,i)=>{const r=new Image;r.crossOrigin="anonymous",r.src=e+"?r="+(new Date).getTime(),r.onload=()=>t(r),r.onerror=e=>i(e)})),a=e=>"number"==typeof e?e:"string"==typeof e?parseInt(e.replace("px","")):0;for(const n of i.watermark)if(n.text&&("string"==typeof n.text&&(n.text={text:n.text,fontSize:18,color:"rgba(255, 255, 255, 0.5)"}),n.text.fontSize=a(n.text.fontSize)),n.img&&("string"==typeof n.img&&(n.img={url:n.img,width:100,height:100}),n.img.width=a(n.img.width),n.img.height=a(n.img.height),n.img.url))try{const t=await r(n.img.url);t.width=n.img.width*e.dpr,t.height=n.img.height*e.dpr,t.style.width=n.img.width+"px",t.style.height=n.img.height+"px",t.style.objectFit="contain",t.referrerPolicy="no-referrer",n.img.el=t}catch(e){return t("Error accessing media devices: watermark image load error")}},r=(e,i)=>{if(!e.canvasCtx||!e.mediaStream)return t("初始化失败");const r=e.canvas.captureStream(30);if(i.isAudio){const t=e.mediaStream.getAudioTracks();t.length>0&&r.addTrack(t[0])}const n=document.createElement("video");return e.processedVideo=n,n.srcObject=new MediaStream(e.mediaStream.getVideoTracks()),n.muted=!0,n.playsInline=!0,n.onloadedmetadata=()=>{n.play().then((()=>{a(n,e,i)})).catch((e=>{t("Error playing video: "+e.message)}))},r},a=(e,i,r)=>{if(!i.canvasCtx)return t("Canvas is not initialized");const o=i.width*i.dpr,s=i.height*i.dpr,d=o/e.videoWidth,c=s/e.videoHeight,h=Math.max(d,c),m=e.videoWidth*h,l=e.videoHeight*h,g=(o-m)/2,p=(s-l)/2;i.canvasCtx.save(),i.canvasCtx.clearRect(0,0,o,s),r.isMirror?(i.canvasCtx.scale(-1,1),i.canvasCtx.drawImage(e,-g-m,p,m,l)):i.canvasCtx.drawImage(e,g,p,m,l),i.canvasCtx.restore(),r.watermark&&r.watermark.length>0&&n(i,r),i.animationFrameId=requestAnimationFrame((()=>a(e,i,r)))},n=(e,t)=>{const i=e.dpr;t.watermark.forEach((t=>{const r=t.x*i,a=t.y*i;e.canvasCtx.save(),t.text?(e.canvasCtx.fillStyle=t.text.color,e.canvasCtx.font=t.text.fontSize*i+"px sans-serif",e.canvasCtx.fillText(t.text.text,r,a)):t.img&&e.canvasCtx.drawImage(t.img.el,r,a,t.img.width*i,t.img.height*i),e.canvasCtx.restore()}))};return class{#e;#t={};#i={};capture;startRecording;stopRecording;destroy;constructor(t){this.#e=e({el:null,facingMode:"environment",isAudio:!1,isMirror:!1,watermark:[{x:10,y:28,text:"p-camera-h5"}]},t),this.#r(),this.capture=()=>new Promise(((e,t)=>{if(!this.#t.canvas)return console.error("请先初始化");e(((e,t)=>{const i=e.split(","),r=i[0].match(/:(.*?);/)[1],a=atob(i[1]);let n=a.length;const o=new Uint8Array(n);for(;n--;)o[n]=a.charCodeAt(n);return new File([o],`pCameraH5-${Date.now()}.${t}`,{type:r})})(this.#t.canvas.toDataURL("image/png"),"png"))})),this.startRecording=()=>new Promise(((e,t)=>this.#i.recorder?console.error("已在录像"):(this.#i.chunks=[],this.#t.canvasStream?(this.#i.recorder=new MediaRecorder(this.#t.canvasStream),this.#i.recorder.ondataavailable=e=>{e.data&&e.data.size>0&&(this.#i.chunks||(this.#i.chunks=[]),this.#i.chunks.push(e.data))},this.#i.recorder.start(),void e(!0)):console.error("请先初始化")))),this.stopRecording=()=>new Promise(((e,t)=>{if(!this.#i.recorder)return console.error("未开始录像");this.#i.recorder.onstop=()=>{const t=new Blob(this.#i.chunks,{type:"video/webm"});e(((e,t)=>new File([e],`pCameraH5-${Date.now()}.${t}`,{type:e.type}))(t,"mp4"))},this.#i.recorder.stop(),this.#i.recorder=null})),this.destroy=()=>{if(!this.#e.el)return console.error("请先初始化");this.#t.animationFrameId&&(cancelAnimationFrame(this.#t.animationFrameId),this.#t.animationFrameId=null),this.#t.mediaStream&&(this.#t.mediaStream.getTracks().forEach((e=>e.stop())),this.#t.mediaStream=null),this.#t.canvasStream&&(this.#t.canvasStream.getTracks().forEach((e=>e.stop())),this.#t.canvasStream=null),this.#i.recorder&&(this.#i.recorder.stop(),this.#i.recorder=null),this.#t.canvas&&(this.#t.canvas=null),this.#t.video&&(this.#t.video=null),this.#t.processedVideo&&(this.#t.processedVideo.srcObject=null,this.#t.processedVideo=null),this.#e.el.innerHTML=""}}async#r(){if(!this.#e.el)return console.error("el is required");this.#e.el.innerHTML='\n  <style>\n    #p-camera-h5 {\n      width: 100%;\n      height: 100%;\n      background-color: #000;\n      position: relative;\n      z-index: 100;\n    }\n    #p-camera-h5 #p-loading,\n    #p-camera-h5 #p-error {\n      box-sizing: border-box;\n      width: 100%;\n      height: 100%;\n      padding: 20% 10%;\n      color: #fff;\n      background-color: #000;\n      line-height: 30px;\n      text-align: center;\n      font-size: 16px;\n      position: absolute;\n      top: 0;\n      left: 0;\n      z-index: 110;\n      display: none;\n    }\n    #p-camera-h5 #p-error {\n      z-index: 111;\n    }\n    #p-camera-h5 #p-video {\n      width: 100%;\n      height: 100%;\n      position: absolute;\n      top: 0;\n      left: 0;\n      z-index: 101;\n    }\n  </style>\n  <div id="p-camera-h5">\n    <div id="p-loading">加载中...</div>\n    <div id="p-error"></div>\n    <video id="p-video" autoplay playsinline muted></video>\n  </div>\n',this.#t.width=this.#e.el.clientWidth,this.#t.height=this.#e.el.clientHeight,this.#t.dpr=window.devicePixelRatio||1;const e=document.getElementById("p-loading"),a=document.createElement("canvas"),n=document.getElementById("p-video");this.#t.canvas=a,this.#t.video=n,e.style.display="block",await(async(e,a)=>{try{e.canvas.width=e.width*e.dpr,e.canvas.height=e.height*e.dpr,e.canvas.style.width=e.width+"px",e.canvas.style.height=e.height+"px",e.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:a.facingMode||"environment"},audio:!!a.isAudio&&{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),e.canvasCtx=e.canvas.getContext("2d",{alpha:!1,willReadFrequently:!1}),e.canvasCtx.imageSmoothingQuality="high",e.canvasCtx.imageSmoothingEnabled=!0,a.watermark&&await i(e,a),e.canvasStream=r(e,a),e.video.srcObject=e.canvasStream}catch(e){return t("Error accessing media devices: "+e.message)}})(this.#t,this.#e),e.style.display="none"}}}));
