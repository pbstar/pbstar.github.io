/*!
* p-camera-h5 v1.0.0-beta.1
* Copyright 2024 Pbstar (https://github.com/pbstar)
* Licensed under MIT (https://github.com/pbstar/p-camera-h5/blob/main/LICENSE)
* 2025-02-22 17:40:40
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).pCameraH5=t()}(this,(function(){"use strict";function e(e,t,r,i){if("a"===r&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?i:"a"===r?i.call(e):i?i.value:t.get(e)}function t(e,t,r,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,r):n?n.value=r:t.set(e,r),r}"function"==typeof SuppressedError&&SuppressedError;const r=(e,t,n)=>{if(!t.canvasCtx||!t.video)return;const a=Math.max(t.video.clientWidth/e.videoWidth,t.video.clientHeight/e.videoHeight),o=e.videoWidth*a,s=e.videoHeight*a,d=(t.video.clientWidth-o)/2,h=(t.video.clientHeight-s)/2;t.canvasCtx.drawImage(e,d,h,o,s),i(t,n),t.animationFrameId=requestAnimationFrame((()=>r(e,t,n)))},i=(e,t)=>{if(!1===e.isWatermarkVisible)return;if(!e.canvasCtx.canvas)throw new Error("Canvas is not initialized");const[r,i]=t.watermark.position.split("-");let n=10,a=25;"right"===i&&(n=e.canvasCtx.canvas.width-100),"bottom"===r&&(a=e.canvasCtx.canvas.height-10),t.watermark.text&&(e.canvasCtx.fillStyle=t.watermark.color,e.canvasCtx.font=`${t.watermark.fontSize} sans-serif`,e.canvasCtx.fillText(t.watermark.text,n,a))},n=async(e,t)=>{try{e.video=document.getElementById("p-video");const i=document.getElementById("p-canvas");e.mediaStream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),e.canvasCtx=i.getContext("2d"),e.canvasStream=((e,t)=>{if(!e.canvasCtx||!e.mediaStream)throw new Error("初始化失败");if(!e.video)throw new Error("video is required");const i=document.getElementById("p-canvas");i.width=e.video.clientWidth,i.height=e.video.clientHeight;const n=i.captureStream(30),a=e.mediaStream.getAudioTracks();a.length>0&&n.addTrack(a[0]);const o=document.createElement("video");return o.srcObject=new MediaStream(e.mediaStream.getVideoTracks()),o.onloadedmetadata=()=>{o.play(),r(o,e,t)},n})(e,t),e.video.srcObject=e.canvasStream}catch(e){throw new Error("Error accessing media devices: "+e.message)}},a=(e,t)=>{const r=document.createElement("a"),i=URL.createObjectURL(e);r.href=i,r.download=t||e.name,document.body.appendChild(r),r.click(),document.body.removeChild(r)};var o,s,d,h,c,f,l,m="#p-camera-h5 {\r\n  width: 100%;\r\n  height: 100%;\r\n  background-color: #000;\r\n  position: relative;\r\n}\r\n#p-camera-h5 div {\r\n  box-sizing: border-box;\r\n}\r\n#p-camera-h5 #p-loading {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  background-color: #000;\r\n  color: #fff;\r\n  line-height: 100px;\r\n  text-align: center;\r\n  font-size: 20px;\r\n  z-index: 200;\r\n}\r\n\r\n#p-camera-h5 #p-container {\r\n  width: 100%;\r\n  height: calc(100% - 150px);\r\n  position: absolute;\r\n  top: 50px;\r\n  left: 0;\r\n}\r\n#p-camera-h5 #p-video {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  object-fit: cover;\r\n}\r\n#p-camera-h5 #p-canvas {\r\n  width: 100%;\r\n  height: 100%;\r\n}\r\n#p-camera-h5 #p-capture-btn,\r\n#p-camera-h5 #p-record-btn {\r\n  width: 80px;\r\n  height: 40px;\r\n  line-height: 40px;\r\n  text-align: center;\r\n  border-radius: 10px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n}\r\n#p-camera-h5 #p-capture-btn {\r\n  position: absolute;\r\n  bottom: 30px;\r\n  left: calc(50% - 90px);\r\n}\r\n#p-camera-h5 #p-record-btn {\r\n  position: absolute;\r\n  bottom: 30px;\r\n  left: calc(50% + 10px);\r\n}\r\n#p-camera-h5 #p-watermark-btn {\r\n  position: absolute;\r\n  top: 15px;\r\n  right: 10px;\r\n  z-index: 100;\r\n  width: 60px;\r\n  height: 20px;\r\n  line-height: 20px;\r\n  text-align: center;\r\n  border-radius: 5px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n  font-size: 12px;\r\n}\r\n#p-camera-h5 #p-record-time {\r\n  width: 100%;\r\n  position: absolute;\r\n  top: 0px;\r\n  left: 0;\r\n  line-height: 50px;\r\n  color: white;\r\n  font-size: 18px;\r\n  text-align: center;\r\n}\r\n";!function(e,t){void 0===t&&(t={});var r=t.insertAt;if("undefined"!=typeof document){var i=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css","top"===r&&i.firstChild?i.insertBefore(n,i.firstChild):i.appendChild(n),n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e))}}(m);return s=new WeakMap,d=new WeakMap,h=new WeakMap,c=new WeakMap,o=new WeakSet,f=function(){if(!e(this,s,"f").el)throw new Error("el is required");e(this,s,"f").el.innerHTML='\n  <div id="p-camera-h5">\n    <div id="p-loading">加载中...</div>\n    <div id="p-error"></div>\n    <div id="p-container">\n      <video id="p-video" autoplay playsinline></video>\n      <canvas id="p-canvas" style="display:none;"></canvas>\n    </div>\n    <div id="p-watermark-btn">关闭水印</div>\n    <div id="p-capture-btn">拍照</div>\n    <div id="p-record-btn">录制</div>\n    <div id="p-record-time">00:00</div>\n  </div>\n';const t=document.createElement("style");let r=Object.values(m).join("");e(this,s,"f").style&&(r+=e(this,s,"f").style),t.innerHTML=r,e(this,s,"f").el.appendChild(t)},l=function(){if(e(this,h,"f")||t(this,h,{},"f"),e(this,h,"f").watermarkBtn=document.getElementById("p-watermark-btn"),e(this,h,"f").captureBtn=document.getElementById("p-capture-btn"),e(this,h,"f").recordBtn=document.getElementById("p-record-btn"),!e(this,h,"f").watermarkBtn||!e(this,h,"f").captureBtn||!e(this,h,"f").recordBtn)throw new Error("Buttons not initialized");e(this,h,"f").watermarkBtn.addEventListener("click",(()=>this.handleWatermark())),e(this,h,"f").captureBtn.addEventListener("click",(()=>this.handleCapture())),e(this,h,"f").recordBtn.addEventListener("click",(()=>this.handleRecording()))},class{constructor(r){if(o.add(this),s.set(this,void 0),d.set(this,void 0),h.set(this,void 0),c.set(this,void 0),t(this,s,{el:null,style:"",watermark:{text:"pCameraH5",position:"bottom-left",color:"rgba(255, 255, 255, 0.5)",fontSize:"18px"}},"f"),!r.el||r.el instanceof HTMLElement==!1)throw new Error("el is required");Object.assign(e(this,s,"f"),r),t(this,d,{},"f"),t(this,h,{},"f"),t(this,c,{},"f"),this.init(),this.api={init:this.init.bind(this),capture:this.capture.bind(this),startRecording:this.startRecording.bind(this),stopRecording:this.stopRecording.bind(this),destroy:this.destroy.bind(this),downloadFile:a.bind(this)},this.on=(t,r)=>{e(this,c,"f")[t]=r},this.off=t=>{delete e(this,c,"f")[t]}}async init(){e(this,o,"m",f).call(this),e(this,o,"m",l).call(this),await n(e(this,d,"f"),e(this,s,"f"));document.getElementById("p-loading").style.display="none"}capture(){if(!e(this,d,"f"))throw new Error("Media is not initialized");if(!e(this,d,"f").canvasCtx)throw new Error("Canvas未初始化");if(!e(this,d,"f").video)throw new Error("Video未初始化");const t=document.createElement("canvas");t.width=e(this,d,"f").video.videoWidth,t.height=e(this,d,"f").video.videoHeight;t.getContext("2d").drawImage(e(this,d,"f").canvasCtx.canvas,0,0),e(this,c,"f")&&e(this,c,"f").capture&&e(this,c,"f").capture(((e,t)=>{const r=e.split(","),i=r[0].match(/:(.*?);/)[1],n=atob(r[1]);let a=n.length;const o=new Uint8Array(a);for(;a--;)o[a]=n.charCodeAt(a);return new File([o],`pCameraH5-${Date.now()}.${t}`,{type:i})})(t.toDataURL("image/png"),"png"))}startRecording(){if(!e(this,d,"f"))throw new Error("Media is not initialized");if(e(this,d,"f").recordedChunks=[],!e(this,d,"f").canvasStream)throw new Error("canvasStream is required");if(e(this,d,"f").mediaRecorder=new MediaRecorder(e(this,d,"f").canvasStream),e(this,d,"f").mediaRecorder.ondataavailable=t=>{if(t.data&&t.data.size>0){if(!e(this,d,"f"))throw new Error("Media is not initialized");e(this,d,"f").recordedChunks||(e(this,d,"f").recordedChunks=[]),e(this,d,"f").recordedChunks.push(t.data)}},!e(this,d,"f").mediaRecorder)throw new Error("mediaRecorder is required");if(e(this,d,"f").mediaRecorder.start(),e(this,d,"f").recordTime=document.getElementById("p-record-time"),!e(this,d,"f").recordTime)throw new Error("recordTime is required");if(!e(this,d,"f").recordTime)throw new Error("recordTime is required");e(this,d,"f").recordTime.style.display="inline";let t=0;e(this,d,"f").recordTimer=window.setInterval((()=>{if(t++,!e(this,d,"f"))throw new Error("recordTime is required");if(!e(this,d,"f").recordTime)throw new Error("recordTime is required");t>=60&&this.stopRecording(),e(this,d,"f").recordTime.textContent=`${Math.floor(t/60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}`}),1e3)}async stopRecording(){if(!e(this,d,"f"))throw new Error("Media is not initialized");if(!e(this,d,"f").mediaRecorder)throw new Error("mediaRecorder is required");e(this,d,"f").mediaRecorder.onstop=()=>{if(!e(this,d,"f"))throw new Error("Media is not initialized");const t=new Blob(e(this,d,"f").recordedChunks,{type:"video/webm"});if(e(this,c,"f")&&e(this,c,"f").record&&e(this,c,"f").record(((e,t)=>new File([e],`pCameraH5-${Date.now()}.${t}`,{type:e.type}))(t,"mp4")),!e(this,d,"f").recordTime||!e(this,d,"f").recordTimer)throw new Error("recordTime is required");clearInterval(e(this,d,"f").recordTimer),e(this,d,"f").recordTime.textContent="00:00"},e(this,d,"f").mediaRecorder.stop()}handleWatermark(){if(!e(this,d,"f"))throw new Error("media is required");if(!e(this,h,"f"))throw new Error("btns is required");if(!e(this,h,"f").watermarkBtn)throw new Error("watermarkBtn is required");null!==e(this,d,"f").isWatermarkVisible&&void 0!==e(this,d,"f").isWatermarkVisible||(e(this,d,"f").isWatermarkVisible=!0),e(this,d,"f").isWatermarkVisible=!e(this,d,"f").isWatermarkVisible,e(this,h,"f").watermarkBtn.textContent=e(this,d,"f").isWatermarkVisible?"关闭水印":"打开水印"}handleCapture(){this.capture()}async handleRecording(){if(!e(this,h,"f"))throw new Error("btns is required");if(!e(this,h,"f").recordBtn)throw new Error("recordBtn is required");"录制"===e(this,h,"f").recordBtn.textContent?(this.startRecording(),e(this,h,"f").recordBtn.textContent="停止"):(await this.stopRecording(),e(this,h,"f").recordBtn.textContent="录制")}destroy(){if(!e(this,d,"f"))throw new Error("media is required");if(!e(this,s,"f"))throw new Error("config is required");if(!e(this,s,"f").el)throw new Error("el is required");if(e(this,d,"f").animationFrameId&&cancelAnimationFrame(e(this,d,"f").animationFrameId),!e(this,d,"f").mediaStream)throw new Error("mediaStream is required");e(this,d,"f").mediaStream.getTracks().forEach((e=>e.stop())),e(this,s,"f").el.innerHTML="",e(this,h,"f")&&(e(this,h,"f").watermarkBtn?.removeEventListener("click",this.handleWatermark),e(this,h,"f").captureBtn?.removeEventListener("click",this.handleCapture),e(this,h,"f").recordBtn?.removeEventListener("click",this.handleRecording))}}}));
