/*!
* p-camera-h5 v1.0.0-beta.3
* Copyright 2024 Pbstar (https://github.com/pbstar)
* Licensed under MIT (https://github.com/pbstar/p-camera-h5/blob/main/LICENSE)
* 2025-02-25 12:11:37
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).pCameraH5=t()}(this,(function(){"use strict";function e(e,t,i,r){if("a"===i&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?r:"a"===i?r.call(e):r?r.value:t.get(e)}function t(e,t,i,r,n){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?n.call(e,i):n?n.value=i:t.set(e,i),i}"function"==typeof SuppressedError&&SuppressedError;const i=(e,t)=>{const i=document.createElement("a"),r=URL.createObjectURL(e);i.href=r,i.download=t||e.name,document.body.appendChild(i),i.click(),document.body.removeChild(i)},r=(...e)=>{const t={};function i(e){return null!==e&&"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)}return e.forEach((e=>{if(i(e))for(const n in e)if(e.hasOwnProperty(n)){const a=e[n],s=t[n];i(a)?(i(s)||(t[n]={}),t[n]=r(s,a)):Array.isArray(a)?t[n]=[...a]:t[n]=a}})),t},n=(e,t)=>{throw e.textContent=t,e.style.display="block",new Error(t)},a=(e,t,i,r)=>{t.canvasCtx&&t.video&&(t.canvasCtx.drawImage(e,0,0,e.videoWidth,e.videoHeight),s(t,i,r),t.animationFrameId=requestAnimationFrame((()=>a(e,t,i,r))))},s=(e,t,i)=>{if(!1===e.isWatermarkVisible)return;if(!1===t.watermark.visible)return;if(!e.canvasCtx.canvas)return n(i,"Canvas is not initialized");const r=window.devicePixelRatio||1,a=t.watermark.x?t.watermark.x*r:10*r,s=t.watermark.y?t.watermark.y*r:10*r;if(t.watermark.text){let i=20;t.watermark.text.fontSize&&(i=t.watermark.text.fontSize.toString().indexOf("px")>-1?parseInt(t.watermark.text.fontSize.replace("px","")):parseInt(t.watermark.text.fontSize));const n=i*r;e.canvasCtx.save(),e.canvasCtx.scale(1/r,1/r),e.canvasCtx.fillStyle=t.watermark.text.color||"#FFFFFF",e.canvasCtx.font=`${n}px sans-serif`,e.canvasCtx.fillText(t.watermark.text.text,a,s),e.canvasCtx.restore()}if(t.watermark.image){const i=t.watermark.image.width?t.watermark.image.width*r:100*r,n=t.watermark.image.height?t.watermark.image.height*r:100*r;e.canvasCtx.save(),e.canvasCtx.scale(1/r,1/r),e.canvasCtx.drawImage(t.watermark.image.element,a,s,i,n),e.canvasCtx.restore()}},o=async(e,t,i)=>{try{e.video=document.getElementById("p-video");const r=document.getElementById("p-canvas");let s="environment";if(t.facingMode&&(s=t.facingMode),e.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:s,width:e.video.clientWidth,height:e.video.clientHeight},audio:t.isAudio}),e.canvasCtx=r.getContext("2d",{alpha:!1,willReadFrequently:!1}),t.watermark.visible&&t.watermark.image){const e=new Image,r=window.devicePixelRatio||1;e.src=t.watermark.image.url+"?r="+Math.random().toString(36).substr(2),e.width=(t.watermark.image.width||100)*r,e.height=(t.watermark.image.height||100)*r,e.crossOrigin="Anonymous",e.style.objectFit="contain",e.referrerPolicy="no-referrer",await new Promise((t=>{e.onload=()=>t(e),e.onerror=()=>(n(i,"Error accessing media devices: watermark image load error"),t(e))})),t.watermark.image.element=e}e.canvasStream=((e,t,i)=>{if(!e.canvasCtx||!e.mediaStream)return n(i,"初始化失败");if(!e.video)return n(i,"video is required");const r=document.getElementById("p-canvas"),s=window.devicePixelRatio||1;r.width=e.video.clientWidth*s,r.height=e.video.clientHeight*s,e.canvasCtx.scale(s,s),e.canvasCtx.imageSmoothingQuality="high",e.canvasCtx.imageSmoothingEnabled=!0;const o=r.captureStream(30);if(t.isAudio){const t=e.mediaStream.getAudioTracks();t.length>0&&o.addTrack(t[0])}const d=document.createElement("video");return d.srcObject=new MediaStream(e.mediaStream.getVideoTracks()),d.onloadedmetadata=()=>{d.play().then((()=>{a(d,e,t,i)}))},o})(e,t,i),e.video.srcObject=e.canvasStream}catch(e){return n(i,"Error accessing media devices: "+e.message)}};var d,c,h,f,m,l,p,u,v="#p-camera-h5 {\r\n  width: 100%;\r\n  height: 100%;\r\n  background-color: #000;\r\n  position: relative;\r\n}\r\n#p-camera-h5 div {\r\n  box-sizing: border-box;\r\n}\r\n#p-camera-h5 #p-loading,\r\n#p-camera-h5 #p-error {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  background-color: #000;\r\n  color: #fff;\r\n  line-height: 30px;\r\n  text-align: center;\r\n  padding: 50px;\r\n  font-size: 18px;\r\n  z-index: 200;\r\n}\r\n#p-camera-h5 #p-error {\r\n  display: none;\r\n  z-index: 900;\r\n}\r\n\r\n#p-camera-h5 #p-container {\r\n  width: 100%;\r\n  height: calc(100% - 150px);\r\n  position: absolute;\r\n  top: 50px;\r\n  left: 0;\r\n}\r\n#p-camera-h5 #p-video {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  object-fit: cover;\r\n}\r\n#p-camera-h5 #p-canvas {\r\n  width: 100%;\r\n  height: 100%;\r\n}\r\n#p-camera-h5 #p-capture-btn,\r\n#p-camera-h5 #p-record-btn {\r\n  width: 80px;\r\n  height: 40px;\r\n  line-height: 40px;\r\n  text-align: center;\r\n  border-radius: 10px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n}\r\n#p-camera-h5 #p-capture-btn {\r\n  position: absolute;\r\n  bottom: 30px;\r\n  left: calc(50% - 90px);\r\n}\r\n#p-camera-h5 #p-record-btn {\r\n  position: absolute;\r\n  bottom: 30px;\r\n  left: calc(50% + 10px);\r\n}\r\n#p-camera-h5 #p-watermark-btn {\r\n  position: absolute;\r\n  top: 15px;\r\n  right: 10px;\r\n  z-index: 100;\r\n  width: 60px;\r\n  height: 20px;\r\n  line-height: 20px;\r\n  text-align: center;\r\n  border-radius: 5px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n  font-size: 12px;\r\n}\r\n#p-camera-h5 #p-record-time {\r\n  width: 100%;\r\n  position: absolute;\r\n  top: 0px;\r\n  left: 0;\r\n  line-height: 50px;\r\n  color: white;\r\n  font-size: 18px;\r\n  text-align: center;\r\n}\r\n";!function(e,t){void 0===t&&(t={});var i=t.insertAt;if("undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css","top"===i&&r.firstChild?r.insertBefore(n,r.firstChild):r.appendChild(n),n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e))}}(v);return c=new WeakMap,h=new WeakMap,f=new WeakMap,m=new WeakMap,l=new WeakMap,d=new WeakSet,p=function(){if(!e(this,c,"f").el)return console.error("el is required");e(this,c,"f").el.innerHTML='\n  <div id="p-camera-h5">\n    <div id="p-loading">加载中...</div>\n    <div id="p-error"></div>\n    <div id="p-container">\n      <video id="p-video" autoplay playsinline></video>\n      <canvas id="p-canvas" style="display:none;"></canvas>\n    </div>\n    <div id="p-watermark-btn">关闭水印</div>\n    <div id="p-capture-btn">拍照</div>\n    <div id="p-record-btn">录制</div>\n    <div id="p-record-time">00:00</div>\n  </div>\n',t(this,l,document.getElementById("p-error"),"f");const i=document.createElement("style");let r=Object.values(v).join("");e(this,c,"f").style&&(r+=e(this,c,"f").style),i.innerHTML=r,e(this,c,"f").el.appendChild(i)},u=function(){if(e(this,f,"f")||t(this,f,{},"f"),e(this,f,"f").watermarkBtn=document.getElementById("p-watermark-btn"),e(this,f,"f").captureBtn=document.getElementById("p-capture-btn"),e(this,f,"f").recordBtn=document.getElementById("p-record-btn"),!e(this,f,"f").watermarkBtn||!e(this,f,"f").captureBtn||!e(this,f,"f").recordBtn)return n(e(this,l,"f"),"Buttons not initialized");e(this,c,"f").watermark&&e(this,c,"f").watermark.visible?e(this,f,"f").watermarkBtn.addEventListener("click",(()=>this.handleWatermark())):e(this,f,"f").watermarkBtn.style.display="none",e(this,f,"f").captureBtn.addEventListener("click",(()=>this.handleCapture())),e(this,f,"f").recordBtn.addEventListener("click",(()=>this.handleRecording()))},class{constructor(n){d.add(this),c.set(this,void 0),h.set(this,void 0),f.set(this,void 0),m.set(this,void 0),l.set(this,void 0),t(this,c,{el:null,facingMode:"environment",isAudio:!1,style:"",watermark:{visible:!1}},"f"),t(this,c,r(e(this,c,"f"),n),"f"),t(this,l,null,"f"),t(this,h,{},"f"),t(this,f,{},"f"),t(this,m,{},"f"),this.init(),this.api={init:this.init.bind(this),capture:this.capture.bind(this),startRecording:this.startRecording.bind(this),stopRecording:this.stopRecording.bind(this),destroy:this.destroy.bind(this),downloadFile:i.bind(this)},this.on=(t,i)=>{e(this,m,"f")[t]=i},this.off=t=>{delete e(this,m,"f")[t]}}async init(){e(this,d,"m",p).call(this),e(this,d,"m",u).call(this),await o(e(this,h,"f"),e(this,c,"f"),e(this,l,"f"));document.getElementById("p-loading").style.display="none"}capture(){if(!e(this,h,"f"))return n(e(this,l,"f"),"Media is not initialized");if(!e(this,h,"f").canvasCtx)return n(e(this,l,"f"),"Canvas未初始化");if(!e(this,h,"f").video)return n(e(this,l,"f"),"Video未初始化");const t=document.createElement("canvas");t.width=e(this,h,"f").video.videoWidth,t.height=e(this,h,"f").video.videoHeight;t.getContext("2d").drawImage(e(this,h,"f").canvasCtx.canvas,0,0),e(this,m,"f")&&e(this,m,"f").capture&&e(this,m,"f").capture(((e,t)=>{const i=e.split(","),r=i[0].match(/:(.*?);/)[1],n=atob(i[1]);let a=n.length;const s=new Uint8Array(a);for(;a--;)s[a]=n.charCodeAt(a);return new File([s],`pCameraH5-${Date.now()}.${t}`,{type:r})})(t.toDataURL("image/png"),"png"))}startRecording(){if(!e(this,h,"f"))return n(e(this,l,"f"),"Media is not initialized");if(e(this,h,"f").recordedChunks=[],!e(this,h,"f").canvasStream)return n(e(this,l,"f"),"canvasStream is required");if(e(this,h,"f").mediaRecorder=new MediaRecorder(e(this,h,"f").canvasStream),e(this,h,"f").mediaRecorder.ondataavailable=t=>{if(t.data&&t.data.size>0){if(!e(this,h,"f"))return n(e(this,l,"f"),"Media is not initialized");e(this,h,"f").recordedChunks||(e(this,h,"f").recordedChunks=[]),e(this,h,"f").recordedChunks.push(t.data)}},!e(this,h,"f").mediaRecorder)return n(e(this,l,"f"),"mediaRecorder is required");if(e(this,h,"f").mediaRecorder.start(),e(this,h,"f").recordTime=document.getElementById("p-record-time"),!e(this,h,"f").recordTime)return n(e(this,l,"f"),"recordTime is required");if(!e(this,h,"f").recordTime)return n(e(this,l,"f"),"recordTime is required");e(this,h,"f").recordTime.style.display="inline";let t=0;e(this,h,"f").recordTimer=window.setInterval((()=>(t++,e(this,h,"f")&&e(this,h,"f").recordTime?(t>=60&&this.stopRecording(),void(e(this,h,"f").recordTime.textContent=`${Math.floor(t/60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}`)):n(e(this,l,"f"),"recordTime is required"))),1e3)}async stopRecording(){return e(this,h,"f")?e(this,h,"f").mediaRecorder?(e(this,h,"f").mediaRecorder.onstop=()=>{if(!e(this,h,"f"))return n(e(this,l,"f"),"Media is not initialized");const t=new Blob(e(this,h,"f").recordedChunks,{type:"video/webm"});if(e(this,m,"f")&&e(this,m,"f").record&&e(this,m,"f").record(((e,t)=>new File([e],`pCameraH5-${Date.now()}.${t}`,{type:e.type}))(t,"mp4")),!e(this,h,"f").recordTime||!e(this,h,"f").recordTimer)return n(e(this,l,"f"),"recordTime is required");clearInterval(e(this,h,"f").recordTimer),e(this,h,"f").recordTime.textContent="00:00"},void e(this,h,"f").mediaRecorder.stop()):n(e(this,l,"f"),"mediaRecorder is required"):n(e(this,l,"f"),"Media is not initialized")}handleWatermark(){return e(this,h,"f")?e(this,f,"f")?e(this,f,"f").watermarkBtn?(null!==e(this,h,"f").isWatermarkVisible&&void 0!==e(this,h,"f").isWatermarkVisible||(e(this,h,"f").isWatermarkVisible=!0),e(this,h,"f").isWatermarkVisible=!e(this,h,"f").isWatermarkVisible,void(e(this,f,"f").watermarkBtn.textContent=e(this,h,"f").isWatermarkVisible?"关闭水印":"打开水印")):n(e(this,l,"f"),"watermarkBtn is required"):n(e(this,l,"f"),"btns is required"):n(e(this,l,"f"),"media is required")}handleCapture(){this.capture()}async handleRecording(){return e(this,f,"f")?e(this,f,"f").recordBtn?void("录制"===e(this,f,"f").recordBtn.textContent?(this.startRecording(),e(this,f,"f").recordBtn.textContent="停止"):(await this.stopRecording(),e(this,f,"f").recordBtn.textContent="录制")):n(e(this,l,"f"),"recordBtn is required"):n(e(this,l,"f"),"btns is required")}destroy(){return e(this,h,"f")?e(this,c,"f")?e(this,c,"f").el?(e(this,h,"f").animationFrameId&&cancelAnimationFrame(e(this,h,"f").animationFrameId),e(this,h,"f").mediaStream?(e(this,h,"f").mediaStream.getTracks().forEach((e=>e.stop())),e(this,c,"f").el.innerHTML="",void(e(this,f,"f")&&(e(this,c,"f").watermark&&e(this,c,"f").watermark.visible&&e(this,f,"f").watermarkBtn?.removeEventListener("click",this.handleWatermark),e(this,f,"f").captureBtn?.removeEventListener("click",this.handleCapture),e(this,f,"f").recordBtn?.removeEventListener("click",this.handleRecording)))):n(e(this,l,"f"),"mediaStream is required")):n(e(this,l,"f"),"el is required"):n(e(this,l,"f"),"config is required"):n(e(this,l,"f"),"media is required")}}}));
