/*!
* p-camera-h5 v1.0.0-beta.2
* Copyright 2024 Pbstar (https://github.com/pbstar)
* Licensed under MIT (https://github.com/pbstar/p-camera-h5/blob/main/LICENSE)
* 2025-02-23 14:18:46
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).pCameraH5=t()}(this,(function(){"use strict";function e(e,t,i,r){if("a"===i&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?r:"a"===i?r.call(e):r?r.value:t.get(e)}function t(e,t,i,r,n){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?n.call(e,i):n?n.value=i:t.set(e,i),i}"function"==typeof SuppressedError&&SuppressedError;const i=(e,t)=>{const i=document.createElement("a"),r=URL.createObjectURL(e);i.href=r,i.download=t||e.name,document.body.appendChild(i),i.click(),document.body.removeChild(i)},r=(...e)=>{const t={};function i(e){return null!==e&&"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)}return e.forEach((e=>{if(i(e))for(const n in e)if(e.hasOwnProperty(n)){const s=e[n],a=t[n];i(s)?(i(a)||(t[n]={}),t[n]=r(a,s)):Array.isArray(s)?t[n]=[...s]:t[n]=s}})),t},n=(e,t)=>{throw e.textContent=t,e.style.display="block",new Error(t)},s=async(e,t,i)=>{try{e.video=document.getElementById("p-video");document.getElementById("p-canvas");let r="environment";return t.facingMode&&(r=t.facingMode),e.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:r},audio:!0}),n(i,"1111")}catch(e){return n(i,"Error accessing media devices: "+e.message)}};var a,o,d,h,c,f,l,p,m="#p-camera-h5 {\r\n  width: 100%;\r\n  height: 100%;\r\n  background-color: #000;\r\n  position: relative;\r\n}\r\n#p-camera-h5 div {\r\n  box-sizing: border-box;\r\n}\r\n#p-camera-h5 #p-loading,\r\n#p-camera-h5 #p-error {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  background-color: #000;\r\n  color: #fff;\r\n  line-height: 30px;\r\n  text-align: center;\r\n  padding-top: 100px;\r\n  font-size: 18px;\r\n  z-index: 200;\r\n}\r\n#p-camera-h5 #p-error {\r\n  display: none;\r\n}\r\n\r\n#p-camera-h5 #p-container {\r\n  width: 100%;\r\n  height: calc(100% - 150px);\r\n  position: absolute;\r\n  top: 50px;\r\n  left: 0;\r\n}\r\n#p-camera-h5 #p-video {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  object-fit: cover;\r\n}\r\n#p-camera-h5 #p-canvas {\r\n  width: 100%;\r\n  height: 100%;\r\n}\r\n#p-camera-h5 #p-capture-btn,\r\n#p-camera-h5 #p-record-btn {\r\n  width: 80px;\r\n  height: 40px;\r\n  line-height: 40px;\r\n  text-align: center;\r\n  border-radius: 10px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n}\r\n#p-camera-h5 #p-capture-btn {\r\n  position: absolute;\r\n  bottom: 30px;\r\n  left: calc(50% - 90px);\r\n}\r\n#p-camera-h5 #p-record-btn {\r\n  position: absolute;\r\n  bottom: 30px;\r\n  left: calc(50% + 10px);\r\n}\r\n#p-camera-h5 #p-watermark-btn {\r\n  position: absolute;\r\n  top: 15px;\r\n  right: 10px;\r\n  z-index: 100;\r\n  width: 60px;\r\n  height: 20px;\r\n  line-height: 20px;\r\n  text-align: center;\r\n  border-radius: 5px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n  font-size: 12px;\r\n}\r\n#p-camera-h5 #p-record-time {\r\n  width: 100%;\r\n  position: absolute;\r\n  top: 0px;\r\n  left: 0;\r\n  line-height: 50px;\r\n  color: white;\r\n  font-size: 18px;\r\n  text-align: center;\r\n}\r\n";!function(e,t){void 0===t&&(t={});var i=t.insertAt;if("undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css","top"===i&&r.firstChild?r.insertBefore(n,r.firstChild):r.appendChild(n),n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e))}}(m);return o=new WeakMap,d=new WeakMap,h=new WeakMap,c=new WeakMap,f=new WeakMap,a=new WeakSet,l=function(){if(!e(this,o,"f").el)return n(e(this,f,"f"),"el is required");e(this,o,"f").el.innerHTML='\n  <div id="p-camera-h5">\n    <div id="p-loading">加载中...</div>\n    <div id="p-error"></div>\n    <div id="p-container">\n      <video id="p-video" autoplay playsinline></video>\n      <canvas id="p-canvas" style="display:none;"></canvas>\n    </div>\n    <div id="p-watermark-btn">关闭水印</div>\n    <div id="p-capture-btn">拍照</div>\n    <div id="p-record-btn">录制</div>\n    <div id="p-record-time">00:00</div>\n  </div>\n',t(this,f,document.getElementById("p-error"),"f");const i=document.createElement("style");let r=Object.values(m).join("");e(this,o,"f").style&&(r+=e(this,o,"f").style),i.innerHTML=r,e(this,o,"f").el.appendChild(i)},p=function(){if(e(this,h,"f")||t(this,h,{},"f"),e(this,h,"f").watermarkBtn=document.getElementById("p-watermark-btn"),e(this,h,"f").captureBtn=document.getElementById("p-capture-btn"),e(this,h,"f").recordBtn=document.getElementById("p-record-btn"),!e(this,h,"f").watermarkBtn||!e(this,h,"f").captureBtn||!e(this,h,"f").recordBtn)return n(e(this,f,"f"),"Buttons not initialized");e(this,o,"f").watermark&&e(this,o,"f").watermark.visible?e(this,h,"f").watermarkBtn.addEventListener("click",(()=>this.handleWatermark())):e(this,h,"f").watermarkBtn.style.display="none",e(this,h,"f").captureBtn.addEventListener("click",(()=>this.handleCapture())),e(this,h,"f").recordBtn.addEventListener("click",(()=>this.handleRecording()))},class{constructor(n){a.add(this),o.set(this,void 0),d.set(this,void 0),h.set(this,void 0),c.set(this,void 0),f.set(this,void 0),t(this,o,{el:null,facingMode:"environment",style:"",watermark:{visible:!1}},"f"),t(this,o,r(e(this,o,"f"),n),"f"),t(this,f,null,"f"),t(this,d,{},"f"),t(this,h,{},"f"),t(this,c,{},"f"),this.init(),this.api={init:this.init.bind(this),capture:this.capture.bind(this),startRecording:this.startRecording.bind(this),stopRecording:this.stopRecording.bind(this),destroy:this.destroy.bind(this),downloadFile:i.bind(this)},this.on=(t,i)=>{e(this,c,"f")[t]=i},this.off=t=>{delete e(this,c,"f")[t]}}async init(){e(this,a,"m",l).call(this),e(this,a,"m",p).call(this),await s(e(this,d,"f"),e(this,o,"f"),e(this,f,"f"));document.getElementById("p-loading").style.display="none"}capture(){if(!e(this,d,"f"))return n(e(this,f,"f"),"Media is not initialized");if(!e(this,d,"f").canvasCtx)return n(e(this,f,"f"),"Canvas未初始化");if(!e(this,d,"f").video)return n(e(this,f,"f"),"Video未初始化");const t=document.createElement("canvas");t.width=e(this,d,"f").video.videoWidth,t.height=e(this,d,"f").video.videoHeight;t.getContext("2d").drawImage(e(this,d,"f").canvasCtx.canvas,0,0),e(this,c,"f")&&e(this,c,"f").capture&&e(this,c,"f").capture(((e,t)=>{const i=e.split(","),r=i[0].match(/:(.*?);/)[1],n=atob(i[1]);let s=n.length;const a=new Uint8Array(s);for(;s--;)a[s]=n.charCodeAt(s);return new File([a],`pCameraH5-${Date.now()}.${t}`,{type:r})})(t.toDataURL("image/png"),"png"))}startRecording(){if(!e(this,d,"f"))return n(e(this,f,"f"),"Media is not initialized");if(e(this,d,"f").recordedChunks=[],!e(this,d,"f").canvasStream)return n(e(this,f,"f"),"canvasStream is required");if(e(this,d,"f").mediaRecorder=new MediaRecorder(e(this,d,"f").canvasStream),e(this,d,"f").mediaRecorder.ondataavailable=t=>{if(t.data&&t.data.size>0){if(!e(this,d,"f"))return n(e(this,f,"f"),"Media is not initialized");e(this,d,"f").recordedChunks||(e(this,d,"f").recordedChunks=[]),e(this,d,"f").recordedChunks.push(t.data)}},!e(this,d,"f").mediaRecorder)return n(e(this,f,"f"),"mediaRecorder is required");if(e(this,d,"f").mediaRecorder.start(),e(this,d,"f").recordTime=document.getElementById("p-record-time"),!e(this,d,"f").recordTime)return n(e(this,f,"f"),"recordTime is required");if(!e(this,d,"f").recordTime)return n(e(this,f,"f"),"recordTime is required");e(this,d,"f").recordTime.style.display="inline";let t=0;e(this,d,"f").recordTimer=window.setInterval((()=>(t++,e(this,d,"f")&&e(this,d,"f").recordTime?(t>=60&&this.stopRecording(),void(e(this,d,"f").recordTime.textContent=`${Math.floor(t/60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}`)):n(e(this,f,"f"),"recordTime is required"))),1e3)}async stopRecording(){return e(this,d,"f")?e(this,d,"f").mediaRecorder?(e(this,d,"f").mediaRecorder.onstop=()=>{if(!e(this,d,"f"))return n(e(this,f,"f"),"Media is not initialized");const t=new Blob(e(this,d,"f").recordedChunks,{type:"video/webm"});if(e(this,c,"f")&&e(this,c,"f").record&&e(this,c,"f").record(((e,t)=>new File([e],`pCameraH5-${Date.now()}.${t}`,{type:e.type}))(t,"mp4")),!e(this,d,"f").recordTime||!e(this,d,"f").recordTimer)return n(e(this,f,"f"),"recordTime is required");clearInterval(e(this,d,"f").recordTimer),e(this,d,"f").recordTime.textContent="00:00"},void e(this,d,"f").mediaRecorder.stop()):n(e(this,f,"f"),"mediaRecorder is required"):n(e(this,f,"f"),"Media is not initialized")}handleWatermark(){return e(this,d,"f")?e(this,h,"f")?e(this,h,"f").watermarkBtn?(null!==e(this,d,"f").isWatermarkVisible&&void 0!==e(this,d,"f").isWatermarkVisible||(e(this,d,"f").isWatermarkVisible=!0),e(this,d,"f").isWatermarkVisible=!e(this,d,"f").isWatermarkVisible,void(e(this,h,"f").watermarkBtn.textContent=e(this,d,"f").isWatermarkVisible?"关闭水印":"打开水印")):n(e(this,f,"f"),"watermarkBtn is required"):n(e(this,f,"f"),"btns is required"):n(e(this,f,"f"),"media is required")}handleCapture(){this.capture()}async handleRecording(){return e(this,h,"f")?e(this,h,"f").recordBtn?void("录制"===e(this,h,"f").recordBtn.textContent?(this.startRecording(),e(this,h,"f").recordBtn.textContent="停止"):(await this.stopRecording(),e(this,h,"f").recordBtn.textContent="录制")):n(e(this,f,"f"),"recordBtn is required"):n(e(this,f,"f"),"btns is required")}destroy(){return e(this,d,"f")?e(this,o,"f")?e(this,o,"f").el?(e(this,d,"f").animationFrameId&&cancelAnimationFrame(e(this,d,"f").animationFrameId),e(this,d,"f").mediaStream?(e(this,d,"f").mediaStream.getTracks().forEach((e=>e.stop())),e(this,o,"f").el.innerHTML="",void(e(this,h,"f")&&(e(this,o,"f").watermark&&e(this,o,"f").watermark.visible&&e(this,h,"f").watermarkBtn?.removeEventListener("click",this.handleWatermark),e(this,h,"f").captureBtn?.removeEventListener("click",this.handleCapture),e(this,h,"f").recordBtn?.removeEventListener("click",this.handleRecording)))):n(e(this,f,"f"),"mediaStream is required")):n(e(this,f,"f"),"el is required"):n(e(this,f,"f"),"config is required"):n(e(this,f,"f"),"media is required")}}}));
